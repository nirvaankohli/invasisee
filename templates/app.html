<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>App • InvaSee</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:ital,wght@0,300..700;1,300..700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}" />
  <!-- Leaflet CSS -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""
  />
  <style>
    /* Bottom nav and views */
    .app-main { padding-top: 6.5rem; padding-bottom: 5rem; }
  .map-wrap { position: relative; }
  #leaflet-map { width: 100%; background: #e5e7eb; border-radius: 0.75rem; }
    .map-plus {
      position: absolute; left: 1rem; bottom: 1rem; z-index: 50;
      width: 2.75rem; height: 2.75rem; border-radius: 9999px;
      display:flex; align-items:center; justify-content:center;
      background: linear-gradient(135deg, var(--brand-sage), var(--brand-primary)); color:#fff;
      box-shadow: 0 8px 16px rgba(0,0,0,.15);
      border: 3px solid #fff; cursor: pointer;
    }
    .views { max-width: 1280px; margin: 0 auto; padding: 0 1rem; }
    .view { display: none; }
    .view.active { display: block; }
    /* Bottom nav */
    .bottom-nav {
      position: fixed; left: 0; right: 0; bottom: 0; z-index: 60;
      background: rgba(255,255,255,.95); backdrop-filter: blur(8px);
      border-top: 1px solid var(--gray-100);
    }
    .bottom-nav-inner { max-width: 640px; margin: 0 auto; position: relative; }
    .nav-row {
      display: grid; grid-template-columns: 1fr 1fr; align-items: center;
      padding: 0.75rem 1rem; gap: 1rem;
    }
    .tab-btn { display:flex; align-items:center; justify-content:center; gap:.5rem; padding:.5rem; color: var(--gray-700); border-radius:.5rem; text-decoration:none; font-weight:600; }
    .tab-btn.active { color: var(--brand-primary); }
    .fab-plus {
      position: absolute; left: 50%; transform: translateX(-50%) translateY(-35%);
      width: 3.25rem; height: 3.25rem; border-radius: 9999px;
      display:flex; align-items:center; justify-content:center;
      background: linear-gradient(135deg, var(--brand-sage), var(--brand-primary)); color:#fff;
      box-shadow: 0 10px 20px rgba(0,0,0,.15);
      border: 3px solid #fff;
      cursor: pointer;
    }
  /* Your Tree */
  .tree-wrap { display:flex; flex-direction:column; align-items:center; justify-content:flex-start; gap:1rem; padding: 1rem 0 1rem; }
  .tree-card { width: 100%; max-width: 560px; border:1px solid var(--gray-100); border-radius: 1rem; background:#fff; box-shadow: 0 10px 25px rgba(0,0,0,.05); padding: 1rem; }
  .tree-stage { display:flex; flex-direction:column; align-items:center; gap:.75rem; padding:.25rem 0 .5rem; }
  .tree-circle { width: 200px; height: 200px; border-radius: 50%; background: radial-gradient(circle at 35% 35%, rgba(255,255,255,.7), rgba(255,255,255,.2)), var(--brand-sage); box-shadow: inset 0 0 40px rgba(0,0,0,.08), 0 12px 28px rgba(0,0,0,.08); border: 8px solid #fff; transition: filter .2s ease; }
  .tree-pot { width: 130px; height: 40px; border-radius: 12px 12px 18px 18px; background: #b5651d; border: 4px solid #fff; box-shadow: 0 4px 10px rgba(0,0,0,.08); }
  .pot_white { background:#e5e7eb !important; }
  .tree-sprite-box { position: relative; width: 200px; height: 200px; }
  .sprite-img { position:absolute; inset:0; width:100%; height:100%; object-fit:contain; display:none; }
  .xp-row { display:flex; align-items:center; gap:.5rem; justify-content:space-between; margin-top:.5rem; }
  .xp-bar { flex:1; height: 14px; background: var(--gray-200); border-radius: 9999px; overflow: hidden; }
  .xp-fill { height: 100%; width: 0%; background: linear-gradient(90deg, var(--brand-sage), var(--brand-primary)); border-radius: 9999px; transition: width .35s ease; }
  .xp-label { font-weight:700; color: var(--gray-700); text-align:right; min-width: 160px; }
  .lvl-badge { font-weight:800; color:#111827; background:#eef2ff; border:1px solid #e5e7eb; padding:.25rem .5rem; border-radius:.5rem; }
  .shop { width: 100%; max-width: 560px; border:1px solid var(--gray-100); border-radius: 1rem; background:#fff; box-shadow: 0 10px 25px rgba(0,0,0,.05); padding: 1rem; }
  .shop-title { font-weight:800; color:#111827; margin-bottom:.5rem; }
  .items { display:grid; grid-template-columns: repeat(2, minmax(0,1fr)); gap:.75rem; }
  .item { border:1px solid var(--gray-200); border-radius:.75rem; padding:.75rem; display:flex; flex-direction:column; gap:.5rem; }
  .item-name { font-weight:700; color:#111827; }
  .item-cost { font-size:.9rem; color:#374151; }
  .item-actions { display:flex; gap:.5rem; }
  .btn-small { padding:.4rem .6rem; border-radius:.5rem; border:1px solid var(--gray-300); background:#fff; font-weight:700; cursor:pointer; }
  .btn-small.primary { background: linear-gradient(135deg, var(--brand-sage), var(--brand-primary)); color:#fff; border-color: transparent; }
  .owned { color:#059669; font-weight:700; font-size:.9rem; }
    /* Ensure Leaflet popup text is readable */
    .leaflet-popup-content { color: #111827; }
  </style>
</head>
<body>
  <header class="header">
    <nav class="nav-container">
      <div class="nav-content">
        <div class="logo-container">
          <svg width="32" height="32" viewBox="0 0 32 32" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
            <path d="M16 4C13 4 10 6 8 8C6 10 4 13 4 16C4 19 6 22 8 24C10 26 13 28 16 28C19 28 22 26 24 24C26 22 28 19 28 16C28 13 26 10 24 8C22 6 19 4 16 4Z" fill="url(#leafGradient)"/>
            <defs>
              <linearGradient id="leafGradient" x1="4" y1="4" x2="28" y2="28">
                <stop offset="0%" stop-color="#8E9C78"/>
                <stop offset="100%" stop-color="#485C11"/>
              </linearGradient>
            </defs>
          </svg>
          <span class="logo-text">Invasisee</span>
        </div>
        <div class="nav-links">
          <a href="/" class="nav-link">Home</a>
          <button id="logout-btn" class="btn btn-outline" style="cursor:pointer;">Log Out</button>
        </div>
      </div>
    </nav>
  </header>

  <main class="app-main">
    <div class="views">
      <!-- MAP VIEW -->
      <section id="view-map" class="view active">
        <div class="map-wrap">
          <div id="leaflet-map"></div>
          <button id="map-plus" class="map-plus" aria-label="Add on map">+</button>
        </div>
      </section>
      <!-- YOUR TREE VIEW -->
      <section id="view-tree" class="view">
        <div class="tree-wrap">
          <div class="tree-card">
            <div style="display:flex; justify-content:space-between; align-items:center;">
              <div class="lvl-badge" id="lvl-badge">Level 1</div>
              <div style="font-weight:700; color:#111827;">XP: <span id="xp-balance">0</span></div>
            </div>
            <div class="tree-stage">
              <div class="tree-sprite-box">
                <img id="sprite-base" alt="tree" class="sprite-img" />
                <img id="sprite-leaves" alt="leaves" class="sprite-img" />
                <img id="sprite-pot" alt="pot" class="sprite-img" />
              </div>
              <div class="tree-circle" id="tree-circle"></div>
              <div class="tree-pot" id="tree-pot"></div>
            </div>
            <div class="xp-row">
              <div class="xp-bar"><div class="xp-fill" id="xp-fill"></div></div>
              <div class="xp-label" id="xp-label">0 / 50</div>
            </div>
          </div>
          <div class="shop">
            <div class="shop-title">Cosmetics Shop</div>
            <div class="items" id="shop-items"></div>
          </div>
        </div>
      </section>
    </div>
  </main>

  <!-- Bottom Navigation -->
  <nav id="bottom-nav" class="bottom-nav">
    <div class="bottom-nav-inner">
      <div class="nav-row">
        <button class="tab-btn active" data-target="view-map">Map</button>
        <button class="tab-btn" data-target="view-tree">Your Tree</button>
      </div>
      <button id="fab-plus" class="fab-plus" aria-label="Add">
        +
      </button>
    </div>
  </nav>

  <!-- Leaflet JS -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
  <script>
    const API_URL = window.location.origin;
    const STORE = [
      { id: 'pot_terracotta', label: 'Terracotta Pot', cost: 50, type: 'pot' },
      { id: 'pot_white', label: 'White Pot', cost: 100, type: 'pot' },
      { id: 'leaves_spring', label: 'Spring Leaves', cost: 75, type: 'leaves' },
      { id: 'leaves_autumn', label: 'Autumn Leaves', cost: 125, type: 'leaves' },
    ];

    // Logout handler
    document.addEventListener('DOMContentLoaded', () => {
      const logoutBtn = document.getElementById('logout-btn');
      if (logoutBtn) {
        logoutBtn.addEventListener('click', async () => {
          try { await fetch(`${API_URL}/api/logout`, { method: 'POST', credentials: 'include' }); } catch {}
          window.location.href = '/auth';
        });
      }
    });

    // Tabs and FAB
    const tabButtons = () => Array.from(document.querySelectorAll('.tab-btn'));
    function setActiveView(id) {
      document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
      document.getElementById(id)?.classList.add('active');
      tabButtons().forEach(b => b.classList.toggle('active', b.dataset.target === id));
      if (id === 'view-map' && window.__leafletMap) {
        setTimeout(() => window.__leafletMap.invalidateSize(), 50);
      }
    }
    document.addEventListener('DOMContentLoaded', () => {
      tabButtons().forEach(btn => btn.addEventListener('click', () => setActiveView(btn.dataset.target)));
      document.getElementById('fab-plus')?.addEventListener('click', () => { window.location.href = '/capture'; });
      document.getElementById('map-plus')?.addEventListener('click', () => { window.location.href = '/capture'; });
      // Load profile when opening Tree tab
      tabButtons().forEach(btn => btn.addEventListener('click', () => {
        if (btn.dataset.target === 'view-tree') loadProfile();
      }));
    });

    // Map sizing
    function sizeMap() {
      const header = document.querySelector('.header');
      const bottom = document.getElementById('bottom-nav');
      const mapEl = document.getElementById('leaflet-map');
      if (!mapEl) return;
      const hH = header ? header.offsetHeight : 0;
      const bH = bottom ? bottom.offsetHeight : 0;
      const avail = window.innerHeight - hH - bH - 24; // small padding
      mapEl.style.height = avail + 'px';
      if (window.__leafletMap) window.__leafletMap.invalidateSize();
    }
    window.addEventListener('resize', sizeMap);
    document.addEventListener('DOMContentLoaded', sizeMap);

    // Initialize Leaflet
    document.addEventListener('DOMContentLoaded', () => {
      const map = L.map('leaflet-map');
      window.__leafletMap = map;
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19,
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
      }).addTo(map);

      function setDefault() { map.setView([39.8283, -98.5795], 4); }
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(
          pos => { const { latitude, longitude } = pos.coords; map.setView([latitude, longitude], 13); },
          () => setDefault(),
          { enableHighAccuracy: true, timeout: 5000, maximumAge: 30000 }
        );
      } else { setDefault(); }

      // Reports layer
      const reportLayer = L.layerGroup().addTo(map);
      async function loadReports() {
        try {
          const res = await fetch(`${API_URL}/api/reports`, { credentials: 'include' });
          const data = await res.json();
          reportLayer.clearLayers();
          const items = data?.reports || [];
          const bounds = L.latLngBounds([]);
          items.forEach(r => {
            if (typeof r.lat !== 'number' || typeof r.lng !== 'number') return;
            let marker;
            if (r.image_url) {
              const html = `<div style="width:40px;height:40px;border-radius:8px;overflow:hidden;box-shadow:0 6px 12px rgba(0,0,0,.25);border:2px solid #fff;background:#eee;">
                <img src="${r.image_url}" alt="${r.species||''}" style="width:100%;height:100%;object-fit:cover;display:block;"/>
              </div>`;
              const icon = L.divIcon({
                html,
                className: 'report-thumb-marker',
                iconSize: [40, 40],
                iconAnchor: [20, 20],
                popupAnchor: [0, -20]
              });
              marker = L.marker([r.lat, r.lng], { icon });
            } else {
              marker = L.circleMarker([r.lat, r.lng], {
                radius: 8,
                color: r.invasive ? '#b91c1c' : '#374151',
                fillColor: r.invasive ? '#ef4444' : '#6b7280',
                fillOpacity: 0.9,
                weight: 2
              });
            }
            const img = r.image_url ? `<div style="margin-bottom:.5rem;"><img src="${r.image_url}" alt="${r.species||''}" style="max-width:220px; border-radius:.5rem; border:1px solid #e5e7eb;"/></div>` : '';
            const html = `
              <div style="min-width:220px;">
                ${img}
                <div style="font-weight:700; color:#111827; margin-bottom:.25rem;">${(r.species||'Unknown')}</div>
                <div style="font-size:.9rem; color:#374151; white-space:pre-wrap;">${(r.summary||'')}</div>
                <div style="margin-top:.25rem; font-size:.8rem; color:#6b7280;">Reported by ${(r.username||'anonymous')} • ${r.created_at||''}</div>
              </div>`;
            marker.bindPopup(html);
            reportLayer.addLayer(marker);
            bounds.extend([r.lat, r.lng]);
          });
          if (!window.__reportsFitted && bounds.isValid()) {
            map.fitBounds(bounds.pad(0.15));
            window.__reportsFitted = true;
          }
        } catch (e) { /* ignore */ }
      }
      // Initial load and refresh when switching to map
      loadReports();
      document.querySelectorAll('.tab-btn').forEach(btn => btn.addEventListener('click', () => {
        if (btn.dataset.target === 'view-map') setTimeout(loadReports, 150);
      }));
      // Periodic refresh
      setInterval(loadReports, 30000);
    });

    async function loadProfile() {
      try {
        const res = await fetch(`${API_URL}/api/profile`, { credentials: 'include' });
        const p = await res.json();
        renderProfile(p);
      } catch {}
    }

    function renderProfile(p) {
      const lvl = p.level || 1;
      const total = p.xp_total || 0;
      const bal = p.xp_balance || 0;
      const prev = p.prev_threshold || 0;
      const next = p.next_threshold || 50;
      const span = Math.max(1, next - prev);
    const pos = Math.max(0, Math.min(100, Math.round((total - prev) / span * 100)));
      document.getElementById('lvl-badge').textContent = `Level ${lvl}`;
      document.getElementById('xp-label').textContent = `${Math.max(0, total - prev)} / ${span}`;
      document.getElementById('xp-fill').style.width = `${pos}%`;
      document.getElementById('xp-balance').textContent = bal;
      // Sprites: try to load images from /static/assets/tree; fallback to CSS shapes if missing
      const circle = document.getElementById('tree-circle');
      const potCss = document.getElementById('tree-pot');
      const imgBase = document.getElementById('sprite-base');
      const imgLeaves = document.getElementById('sprite-leaves');
      const imgPot = document.getElementById('sprite-pot');
      // Hide all sprite imgs by default
      [imgBase, imgLeaves, imgPot].forEach(img => { img.style.display = 'none'; img.removeAttribute('src'); });
      // Base tree by level
      const baseSrc = `/static/assets/tree/sprite_${4 - (Math.min(Math.max(lvl,1),5) - 1)}.png`;
      let anySpriteShown = false;
      imgBase.onerror = () => { imgBase.style.display = 'none'; };
      imgBase.onload = () => { imgBase.style.display = 'block'; showOrHideFallback(); };
      imgBase.src = baseSrc;
      // Active cosmetic controls either leaves or pot overlay
      const active = p.active_cosmetic || '';
      if (active.startsWith('leaves_')) {
        const leafMap = { 'leaves_spring': 'leaves_spring.png', 'leaves_autumn': 'leaves_autumn.png' };
        const leafSrc = leafMap[active] ? `/static/assets/tree/${leafMap[active]}` : '';
        if (leafSrc) {
          imgLeaves.onerror = () => { imgLeaves.style.display = 'none'; showOrHideFallback(); };
          imgLeaves.onload = () => { imgLeaves.style.display = 'block'; showOrHideFallback(); };
          imgLeaves.src = leafSrc;
        }
      } else if (active.startsWith('pot_')) {
        const potMap = { 'pot_white': 'pot_white.png', 'pot_terracotta': 'pot_terracotta.png' };
        const potSrc = potMap[active] ? `/static/assets/tree/${potMap[active]}` : '';
        if (potSrc) {
          imgPot.onerror = () => { imgPot.style.display = 'none'; showOrHideFallback(); };
          imgPot.onload = () => { imgPot.style.display = 'block'; showOrHideFallback(); };
          imgPot.src = potSrc;
        }
      }
      function showOrHideFallback() {
        const any = (imgBase.style.display === 'block') || (imgLeaves.style.display === 'block') || (imgPot.style.display === 'block');
        circle.style.display = any ? 'none' : 'block';
        potCss.style.display = any ? 'none' : 'block';
      }
      // Shop items
      const unlocked = new Set(p.unlocked_cosmetics || []);
      const wrap = document.getElementById('shop-items');
      wrap.innerHTML = '';
      STORE.forEach(it => {
        const el = document.createElement('div');
        el.className = 'item';
        el.innerHTML = `
          <div class="item-name">${it.label}</div>
          <div class="item-cost">Cost: ${it.cost} XP</div>
          <div class="item-actions"></div>`;
        const actions = el.querySelector('.item-actions');
        if (unlocked.has(it.id)) {
          if (p.active_cosmetic === it.id) {
            const span = document.createElement('span'); span.className = 'owned'; span.textContent = 'Equipped'; actions.appendChild(span);
          } else {
            const btn = document.createElement('button'); btn.className = 'btn-small'; btn.textContent = 'Equip';
            btn.onclick = async () => {
              await fetch(`${API_URL}/api/cosmetics/equip`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, credentials: 'include', body: JSON.stringify({ id: it.id }) });
              loadProfile();
            };
            actions.appendChild(btn);
          }
        } else {
          const btn = document.createElement('button'); btn.className = 'btn-small primary'; btn.textContent = 'Buy';
          btn.onclick = async () => {
            const r = await fetch(`${API_URL}/api/cosmetics/purchase`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, credentials: 'include', body: JSON.stringify({ id: it.id }) });
            if (!r.ok) { const e = await r.json().catch(()=>({detail:'error'})); alert(e.detail||'Cannot purchase'); return; }
            loadProfile();
          };
          actions.appendChild(btn);
        }
        wrap.appendChild(el);
      });
    }
  </script>
</body>
</html>
